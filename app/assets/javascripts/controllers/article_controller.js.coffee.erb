Blog = angular.module("Blog")


Blog.config ($routeProvider) ->
  $routeProvider.when('/articles/new', 
    templateUrl: '<%= asset_path('assets/articles/new.html') %>', 
    controller: 'ArticleController'
  )
  .when('/articles/:id', 
    templateUrl: '<%= asset_path('assets/articles/show.html') %>', 
    controller: 'ArticleController'
  )
  .when('/articles/:id/edit',
    templateUrl: '<%= asset_path('assets/articles/edit.html') %>', 
    controller: 'ArticleController'
  )


Blog.controller('ArticleController', ($scope, $routeParams, Article, Comment) ->
  if $routeParams.id
    $scope.article_id = $routeParams.id
    Article.get(id: $routeParams.id).$promise.then (article) ->
      $scope.article = article
      $scope.article.comments = _.map($scope.article.comments, (comment) ->
        new Comment(comment)
      )
  else
    $scope.article = new Article()

  $scope.updateArticle = () ->
    if ($scope.article.id?)
      $scope.article.$update()
    else
      $scope.article.$save()  

  $scope.deleteArticle = () ->
    $scope.article.$delete() 

  $scope.deleteComment = (comment) ->
    comment.$delete().then (response) -> 
      $scope.article.comments = _.reject($scope.article.comments, (comment2) -> 
        comment.id is comment2.id
      )
    .catch (response) ->
      alert("oh crap")

)